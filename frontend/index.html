<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Health Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="./src/scripts/main.js"></script>
    <script type="module" src="src/scripts/auth.js" defer></script>
    <link rel="stylesheet" href="src/style.css" />
    <style>
      /* Updated sidebar section styles */
      .sidebar-section {
        display: none;
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, opacity 0.3s ease;
        margin: 0;
      }
      
      .sidebar-section.visible {
        display: block;
        opacity: 1;
        max-height: 1000px;
        margin-bottom: 1rem;
      }
      
      /* Always show the navigation section */
      .sidebar-nav-container {
        display: block !important;
        opacity: 1 !important;
        max-height: 1000px !important;
        margin-bottom: 1rem !important;
      }
    </style>
  </head>

  <body>
    <div id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <h2>Patient Portal</h2>
        <button class="close-sidebar" id="closeSidebar">&times;</button>
      </div>

      <!-- Navigation menu - always visible -->
      <div class="sidebar-section sidebar-nav-container visible">
        <div class="profile-avatar">üò∑</div>
        <h3 style="text-align: center; margin-bottom: 1rem"></h3>

        <ul class="sidebar-nav">
          <li class="sidebar-nav-item" data-section="personal-info">
            <span class="nav-icon">üë§</span> Profile
          </li>
          <li class="sidebar-nav-item" data-section="health-data">
            <span class="nav-icon">üìä</span> Health Data
          </li>
          <li class="sidebar-nav-item" data-section="emergency-contacts">
            <span class="nav-icon">üìû</span> Emergency Contacts
          </li>
          <li class="sidebar-nav-item" data-section="medical-history">
            <span class="nav-icon">üìú</span> Medical History            
          </li>
          <li class="sidebar-nav-item" data-section="lifestyle">
            <span class="nav-icon">üèãÔ∏è</span> Lifestyle
          </li>
          <li class="sidebar-nav-item" data-section="settings">
            <span class="nav-icon">‚öôÔ∏è</span> Settings
          </li>
        </ul>
      </div>

      <!-- Content sections - hidden by default, shown only when selected -->
      <div class="sidebar-section" id="personal-info-section">
        <h3 class="sidebar-section-title">
          <span class="nav-icon">üë§</span> Personal Info
        </h3>
        <div class="sidebar-section-content">
          <!-- Personal info content will be loaded dynamically -->
        </div>
      </div>
      
      <div class="sidebar-section" id="lifestyle-section">
        <h3 class="sidebar-section-title">
          <span class="nav-icon">üèãÔ∏è</span> Lifestyle
        </h3>
        <div class="sidebar-section-content">
          <!-- Lifestyle content will be loaded dynamically -->
        </div>
      </div>

      <div class="sidebar-section" id="emergency-contacts-section">
        <h3 class="sidebar-section-title">
          <span class="nav-icon">üìû</span> Emergency Contacts
        </h3>
        <div class="sidebar-section-content">
          <!-- Emergency contacts will be loaded dynamically -->
        </div>
      </div>

      <div class="sidebar-section" id="medical-history-section">
        <h3 class="sidebar-section-title">
          <span class="nav-icon">üìú</span> Medical History
        </h3>
        <div class="sidebar-section-content">
          <div class="timeline">
            <div class="timeline-item">
              <div class="timeline-date">2024-01-15</div>
              <div class="timeline-title">Routine Checkup</div>
              <div class="timeline-description">
                All vitals normal. Recommended continued exercise regimen.
              </div>
            </div>
            <div class="timeline-item">
              <div class="timeline-date">2023-11-20</div>
              <div class="timeline-title">Minor Ankle Sprain</div>
              <div class="timeline-description">
                R.I.C.E. treatment prescribed. Follow-up in 2 weeks.
              </div>
            </div>
            <div class="timeline-item">
              <div class="timeline-date">2023-08-05</div>
              <div class="timeline-title">Annual Physical</div>
              <div class="timeline-description">
                Blood work showed slightly elevated cholesterol. Started on
                Atorvastatin.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="sidebar-section" id="health-data-section">
        <h3 class="sidebar-section-title">
          <span class="nav-icon">üìä</span> Health Data
        </h3>
        <div class="sidebar-section-content">
          <div class="data-item">
            <span class="data-label">Average Heart Rate</span>
            <span class="data-value">72 BPM</span>
          </div>
          <div class="data-item">
            <span class="data-label">Average SpO2</span>
            <span class="data-value">98%</span>
          </div>
          <div class="data-item">
            <span class="data-label">Latest Blood Pressure</span>
            <span class="data-value">120/80 mmHg</span>
          </div>
        </div>
      </div>

      <div class="sidebar-section" id="settings-section">
        <h3 class="sidebar-section-title">
          <span class="nav-icon">‚öôÔ∏è</span> Settings
        </h3>
        <div class="sidebar-section-content">
          <div class="data-item">
            <span class="data-label">Notifications</span>
            <span class="data-value">Enabled</span>
          </div>
          <div class="data-item">
            <span class="data-label">Data Sharing</span>
            <span class="data-value">Limited</span>
          </div>
          <div class="data-item">
            <span class="data-label">Theme</span>
            <span class="data-value">Dark</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="content-wrapper" id="contentWrapper">
      <a href="src/markup/sign-up.html">sign up</a>
      <div class="header">
        <h1>Health Dashboard</h1>
        <div class="user-info" id="userProfile">
          <div class="user-avatar">üåö</div>
          <span></span>
        </div>
      </div>

      <div class="grids">
        <div class="dashboard-grid">
          <div class="metric-card">
            <div class="metric-title">Heart Rate</div>
            <div class="metric-value"><span id="heartRate">75</span> BPM</div>
            <div class="status normal">Normal</div>
          </div>
          <div class="metric-card">
            <div class="metric-title">SpO2</div>
            <div class="metric-value"><span id="spo2">98</span>%</div>
            <div class="status normal">Normal</div>
          </div>
        </div>
        <div class="charts-grid">
          <div
            class="chart-card"
            id="ecgChart"
            style="width: 100%; height: 300px"
          ></div>
          <div
            class="chart-card"
            id="spo2Chart"
            style="width: 100%; height: 300px"
          ></div>
        </div>
      </div>

      <div class="history">
        <div class="history-card">
          <h3>History Log</h3>
          <table class="history-table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Heart Rate</th>
                <th>SpO2</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="historyTableBody"></tbody>
          </table>
        </div>

        <div class="right-column">
          <div class="card">
            <button class="emergency-btn emergency-services">
              Emergency Services üö®
            </button>
            <button class="emergency-btn call-doctor">Call Doctor üßë‚Äç‚öïÔ∏è</button>
          </div>
        </div>
      </div>
    </div>

    <div id="overlay" class="modal-overlay"></div>
  </body>

  <script type="module">
    import { supabase } from "./src/scripts/auth.js";

    // Fix 1: Define the initializeSupabase function
    function initializeSupabase() {
      return supabase;
    }

    async function say() {
      console.log(await supabase.auth.getSession());
    }

    say();
    
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const { data: sessionData, error } = await supabase.auth.getSession();

        if (error || !sessionData || !sessionData.session) {
          console.error("No active session");
          return;
        }

        const user_id = sessionData.session.user.id;
        console.log("User ID:", user_id);

        await loadAllUserData(user_id);
      } catch (error) {
        console.error("Error in DOMContentLoaded:", error);
      }
    });

    document.addEventListener("DOMContentLoaded", async function () {
      // Initialize charts
      const ecgChart = echarts.init(document.getElementById("ecgChart"));
      const spo2Chart = echarts.init(document.getElementById("spo2Chart"));

      // ECG Chart configuration
      const ecgData = Array.from({ length: 50 }, (_, i) => [
        i,
        Math.sin(i / 5) * 10 + Math.random() * 2,
      ]);

      const ecgOption = {
        title: { text: "ECG Waveform" },
        xAxis: { type: "category" },
        yAxis: { type: "value" },
        series: [
          {
            type: "line",
            data: ecgData,
            smooth: true,
            lineStyle: {
              width: 2,
            },
          },
        ],
      };
      ecgChart.setOption(ecgOption);

      // SpO2 Chart configuration
      const spo2Data = Array.from({ length: 50 }, (_, i) => [
        i,
        95 + Math.random() * 3,
      ]);

      const spo2Option = {
        title: { text: "SpO2 Levels" },
        xAxis: { type: "category" },
        yAxis: {
          type: "value",
          min: 90,
          max: 100,
        },
        series: [
          {
            type: "line",
            data: spo2Data,
            smooth: true,
            lineStyle: {
              width: 2,
            },
          },
        ],
      };
      spo2Chart.setOption(spo2Option);

      // Profile Handler Code
      const userProfile = document.getElementById("userProfile");
      const sidebar = document.querySelector(".sidebar");
      const overlay = document.getElementById("overlay");
      const closeSidebarBtn = document.getElementById("closeSidebar");
      const contentWrapper = document.getElementById("contentWrapper");

      // Profile click handler
      userProfile.addEventListener("click", async function () {
        try {
          const {
            data: { session },
            error,
          } = await supabase.auth.getSession();

          if (error) throw error;

          if (!session) {
            console.error("No active session");
            window.location.href = "/src/markup/sign-up.html";
            return;
          }

          await loadAllUserData(session.user.id);

          // Show sidebar and overlay
          sidebar.classList.add("open");
          overlay.classList.add("show");
          contentWrapper.classList.add("sidebar-open");

          // Ensure only navigation menu is visible on open
          document.querySelector(".sidebar-nav-container").classList.add("visible");
          
          // Hide all content sections initially
          document
            .querySelectorAll(".sidebar-section:not(.sidebar-nav-container)")
            .forEach((section) => {
              section.classList.remove("visible");
            });
        } catch (error) {
          console.error("Error loading profile:", error);
          alert("Error loading profile data");
        }
      });

      // Close sidebar handler
      function closeSidebar() {
        sidebar.classList.remove("open");
        overlay.classList.remove("show");
        contentWrapper.classList.remove("sidebar-open");
      }

      closeSidebarBtn.addEventListener("click", closeSidebar);
      overlay.addEventListener("click", closeSidebar);

      // Improved navigation handler - each click shows only that section and hides others
      const navItems = document.querySelectorAll(".sidebar-nav-item");
      navItems.forEach((item) => {
        item.addEventListener("click", function () {
          // Remove active class from all items
          navItems.forEach((nav) => nav.classList.remove("active"));
          // Add active class to clicked item
          this.classList.add("active");

          // Hide all content sections first
          document
            .querySelectorAll(".sidebar-section:not(.sidebar-nav-container)")
            .forEach((section) => {
              section.classList.remove("visible");
            });

          // Show the selected section
          const sectionName = this.getAttribute("data-section");
          const targetSection = document.getElementById(
            `${sectionName}-section`
          );
          if (targetSection) {
            targetSection.classList.add("visible");
          }
        });
      });
    });

    // Data loading and update functions
    async function loadAllUserData(user_id) {
      try {
        const [
          { data: user },
          { data: personalInfo },
          { data: medicalInfo },
          { data: lifestyle },
          { data: emergencyContactsData },
        ] = await Promise.all([
          supabase.from("users").select("*").eq("id", user_id).single(),
          supabase
            .from("personal_info")
            .select("*")
            .eq("user_id", user_id)
            .single(),
          supabase
            .from("medical_info")
            .select("*")
            .eq("user_id", user_id)
            .single(),
          supabase
            .from("lifestyle")
            .select("*")
            .eq("user_id", user_id)
            .single(),
          supabase
            .from("emergency_contacts")
            .select("*")
            .eq("user_id", user_id),
        ]);

        if (
          !user ||
          !personalInfo ||
          !medicalInfo ||
          !lifestyle ||
          !Array.isArray(emergencyContactsData)
        ) {
          throw new Error(
            "Could not fetch user data or emergencyContacts is not an array"
          );
        }

        updateProfileHeaders(user.name);
        updatePersonalInfo(user, personalInfo);
        updateMedicalInfo(medicalInfo);
        updateLifestyleInfo(lifestyle);
        updateEmergencyContacts(emergencyContactsData);
      } catch (error) {
        console.error("Error in loadAllUserData:", error);
        throw error;
      }
    }

    function updateProfileHeaders(userName) {
      document.querySelector(
        ".sidebar-header h2"
      ).textContent = `${userName}'s Portal`;
      document.querySelector(".sidebar-nav-container h3").textContent = userName;
      document.querySelector(".user-info span").textContent = userName;
    }

    function updatePersonalInfo(user, personalInfo) {
      const container = document.querySelector(
        "#personal-info-section .sidebar-section-content"
      );

      if (!container) return;

      container.innerHTML = `
            <div class="data-item">
                <span class="data-label">Full Name</span>
                <span class="data-value">${user.name}</span>
            </div>
            <div class="data-item">
                <span class="data-label">Email</span>
                <span class="data-value">${user.email}</span>
            </div>
            <div class="data-item">
                <span class="data-label">Date of Birth</span>
                <span class="data-value">${new Date(
                  personalInfo.dob
                ).toLocaleDateString()}</span>
            </div>
            <div class="data-item">
                <span class="data-label">Blood Type</span>
                <span class="data-value">${
                  personalInfo.blood_type || "Not specified"
                }</span>
            </div>
            <div class="data-item">
                <span class="data-label">Height</span>
                <span class="data-value">${
                  personalInfo.height_cm || "Not specified"
                } cm</span>
            </div>
            <div class="data-item">
                <span class="data-label">Weight</span>
                <span class="data-value">${
                  personalInfo.weight_kg || "Not specified"
                } kg</span>
            </div>
        `;
    }

    function updateMedicalInfo(medicalInfo) {
      const container = document.querySelector(
        "#medical-history-section .sidebar-section-content"
      );

      if (!container) return;

      const conditions = [
        { name: "Diabetes", value: medicalInfo.diabetes },
        { name: "Hypertension", value: medicalInfo.hypertension },
        { name: "Heart Disease", value: medicalInfo.heart_disease },
        { name: "Asthma", value: medicalInfo.asthma },
        { name: "Allergies", value: medicalInfo.allergies },
      ];

      // Clear previous content
      container.innerHTML = "";

      // Add medical conditions if they exist
      conditions.forEach((condition) => {
        if (condition.value) {
          // Only show if true
          const div = document.createElement("div");
          div.className = "medical-condition active";
          div.innerHTML = `
              <span class="condition-name"> Diagnosed with : ${condition.name} </span>
              <span class="condition-status"></span>
          `;
          container.appendChild(div);
        }
      });

      // Add medical notes if available
      if (medicalInfo.notes) {
        const notesDiv = document.createElement("div");
        notesDiv.classList.add("notes-section");
        notesDiv.innerHTML = `
          <h4>Additional Notes</h4>
          <p>${medicalInfo.notes}</p>
        `;
        container.appendChild(notesDiv);
      }

      // Add the timeline elements back after clearing
      const timelineDiv = document.createElement("div");
      timelineDiv.className = "timeline";
      timelineDiv.innerHTML = `
        <div class="timeline-item">
          <div class="timeline-date">2024-01-15</div>
          <div class="timeline-title">Routine Checkup</div>
          <div class="timeline-description">
            All vitals normal. Recommended continued exercise regimen.
          </div>
        </div>
        <div class="timeline-item">
          <div class="timeline-date">2023-11-20</div>
          <div class="timeline-title">Minor Ankle Sprain</div>
          <div class="timeline-description">
            R.I.C.E. treatment prescribed. Follow-up in 2 weeks.
          </div>
        </div>
        <div class="timeline-item">
          <div class="timeline-date">2023-08-05</div>
          <div class="timeline-title">Annual Physical</div>
          <div class="timeline-description">
            Blood work showed slightly elevated cholesterol. Started on
            Atorvastatin.
          </div>
        </div>
      `;
      container.appendChild(timelineDiv);
    }

    function updateEmergencyContacts(emergencyContacts) {
      const container = document.querySelector(
        "#emergency-contacts-section .sidebar-section-content"
      );
      if (!container) return;

      container.innerHTML = ""; // Clear existing content

      if (!Array.isArray(emergencyContacts) || emergencyContacts.length === 0) {
        container.innerHTML =
          "<div class='no-contacts'>No emergency contacts available</div>";
        return;
      }

      emergencyContacts.forEach((contact) => {
        const contactDiv = document.createElement("div");
        contactDiv.classList.add("contact-item");
        contactDiv.innerHTML = `
            <div class="contact-name"><strong>${contact.name}</strong> (${
          contact.relationship
        })</div>
            <div class="contact-phone">üìû ${contact.phone}</div>
            <div class="contact-email">‚úâÔ∏è ${contact.email}</div>
            ${
              contact.is_primary
                ? '<div class="primary-contact">‚≠ê Primary Contact</div>'
                : ""
            }
        `;
        container.appendChild(contactDiv);
      });
    }

    function updateLifestyleInfo(lifestyle) {
      const container = document.querySelector(
        "#lifestyle-section .sidebar-section-content"
      );
      if (!container) return;

      container.innerHTML = `
        <div class="data-item">
            <span class="data-label">Smoking</span>
            <span class="data-value">${
              lifestyle.smoking ? "Yes üö¨" : "No üö≠"
            }</span>
        </div>
        <div class="data-item">
            <span class="data-label">Alcohol</span>
            <span class="data-value">${
              lifestyle.alcohol ? "Yes üç∑" : "No "
            }</span>
        </div>
        <div class="data-item">
            <span class="data-label">Exercise</span>
            <span class="data-value">${
              lifestyle.exercise ? "Yes üèãÔ∏è" : "No ‚ùå"
            }</span>
        </div>
      `;
    }

    // Handle window resize events for chart responsiveness
    window.addEventListener('resize', function() {
      const ecgChart = echarts.getInstanceByDom(document.getElementById("ecgChart"));
      const spo2Chart = echarts.getInstanceByDom(document.getElementById("spo2Chart"));
      
      if (ecgChart) {
        ecgChart.resize();
      }
      
      if (spo2Chart) {
        spo2Chart.resize();
      }
    });
  </script>
</html>